<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²çµ¡æ¶æ§‹å¸« Network Architect (Bilingual)</title>
    <style>
        :root {
            --bg-color: #f4f6f7;
            --board-bg: #ffffff;
            --accent-color: #2c3e50;
            --highlight: #e74c3c;
            --text-color: #34495e;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --slot-border: #95a5a6;
        }
        body {
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }
        h1 { margin: 10px 0; color: var(--accent-color); font-size: 1.8em; letter-spacing: 1px; text-align: center; }
        .subtitle { color: #7f8c8d; margin-bottom: 15px; font-size: 1em; }

        .game-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 950px;
            gap: 15px;
            position: relative;
            z-index: 1;
        }

        /* é¡Œç›®å¡ */
        .question-card {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-left: 6px solid var(--accent-color);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .level-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .level-title { font-weight: 800; font-size: 1.2em; color: var(--accent-color); }
        .concept-tag { 
            background: #e8f6f3; color: #16a085; 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold;
            border: 1px solid #16a085;
        }
        .level-desc { font-size: 1em; line-height: 1.5; color: #555; }

        /* éŠæˆ²ç•«å¸ƒ */
        .game-board {
            background-color: var(--board-bg);
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            width: 100%;
            height: 450px;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 2px solid #bdc3c7;
            z-index: 5;
        }

        .connections { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* ç·šè·¯æ¨£å¼ */
        .cable-copper { stroke: #e67e22; stroke-width: 4; } 
        .cable-stp { stroke: #8e44ad; stroke-width: 5; stroke-dasharray: 6,3; } 
        .cable-fiber { stroke: #3498db; stroke-width: 4; } 
        .cable-wireless { stroke: #bdc3c7; stroke-width: 3; stroke-dasharray: 6,6; } 
        .cable-bluetooth { stroke: #3498db; stroke-width: 2; stroke-dasharray: 3,3; } 
        .cable-satellite { stroke: #f1c40f; stroke-width: 3; stroke-dasharray: 10,5; } 
        .cable-slot { stroke: #bdc3c7; stroke-width: 3; stroke-dasharray: 4; } 
        
        /* è¨­å‚™æ¨£å¼ */
        .device {
            width: 100px;
            height: 90px;
            background-color: #fff;
            border: 2px solid #34495e;
            color: #333;
            border-radius: 12px;
            position: absolute;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            text-align: center;
            padding: 2px;
            transition: all 0.3s;
        }
        .device-icon { font-size: 2em; margin-bottom: 0px; }
        .device-label { font-size: 0.75em; font-weight: bold; line-height: 1.1; color: #2c3e50; margin-top: 2px; }

        /* æ’æ§½æ¨£å¼ */
        .slot {
            width: 100px;
            height: 100px;
            border: 3px dashed var(--slot-border);
            border-radius: 12px;
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #95a5a6;
            font-size: 0.8em;
            background: rgba(255,255,255,0.9);
            z-index: 5;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            padding: 5px;
        }
        .slot:hover { border-color: var(--highlight); color: var(--highlight); background: #fff; }
        .slot.filled { border-style: solid; border-color: var(--success); background: white; color: #333; }
        .slot-cable { width: 140px; height: 50px; border-radius: 25px; }

        /* å°åŒ… */
        .packet {
            width: 18px;
            height: 18px;
            background-color: var(--success);
            border-radius: 50%;
            position: absolute;
            z-index: 20;
            display: none;
            box-shadow: 0 0 10px var(--success);
            border: 3px solid white;
        }
        .packet-hacker {
            background-color: var(--danger) !important;
            box-shadow: 0 0 10px var(--danger) !important;
        }

        /* åº•éƒ¨æ§åˆ¶æ¬„ */
        .controls {
            background-color: white;
            padding: 10px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100;
            box-sizing: border-box;
            border-top: 1px solid #ddd;
        }
        
        body { padding-bottom: 240px; } /* ç‚ºåº•éƒ¨ç•™ç©º */

        .inventory {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .inv-item {
            background-color: #f8f9fa;
            color: #2c3e50;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #bdc3c7;
            font-size: 0.75em;
            min-width: 80px;
            max-width: 100px;
            display: flex; flex-direction: column; align-items: center;
            transition: all 0.2s;
            text-align: center;
            line-height: 1.2;
        }
        .inv-item:hover { transform: translateY(-3px); border-color: var(--accent-color); }
        .inv-item.selected { border-color: var(--highlight); background-color: #fadbd8; transform: translateY(-3px); }

        .btn-action {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 10px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            transition: all 0.3s;
        }
        .btn-action:hover { background-color: #219150; transform: scale(1.05); }
        .btn-action:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* å½ˆçª— */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 200;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; color: #333; padding: 30px; border-radius: 20px;
            text-align: center; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-top: 10px solid var(--accent-color);
            animation: popIn 0.3s;
        }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .hidden { display: none !important; }

        .noise-zone {
            position: absolute; border: 3px dashed var(--warning); background: rgba(243, 156, 18, 0.1);
            color: var(--warning); font-weight: bold; display: flex; justify-content: center; align-items: center;
            z-index: 0; border-radius: 10px; text-align: center;
        }
    </style>
</head>
<body>

    <h1>ğŸŒ ç¶²çµ¡æ¶æ§‹å¸«</h1>
    <p class="subtitle">ICT ç¶²çµ¡åŸºç¤æ¨¡æ“¬å™¨ (Network Architect)</p>

    <div class="game-container">
        <div class="question-card">
            <div class="level-header">
                <span class="level-title" id="lvl-title">è¼‰å…¥ä¸­...</span>
                <span class="concept-tag" id="lvl-concept">æ¦‚å¿µ</span>
            </div>
            <div class="level-desc" id="lvl-desc">...</div>
        </div>

        <div class="game-board" id="board">
            <svg class="connections" id="svg-lines"></svg>
            <div id="env-layer"></div>
            <div id="device-layer"></div>
            <div id="packet-container"></div> 
        </div>
    </div>

    <div class="controls">
        <p style="margin: 0 0 10px 0; color: #7f8c8d; font-size: 0.9em;">ğŸ‘‡ è«‹é»æ“Šä¸‹æ–¹ç‰©å“ï¼Œç„¶å¾Œæ”¾å…¥ä¸Šæ–¹è™›ç·šæ¡†ä¸­ (Select item & place in slot)</p>
        <div class="inventory" id="inventory"></div>
        <button class="btn-action" id="btn-test" onclick="testNetwork()">ğŸš€ å•Ÿå‹•ç¶²çµ¡ (Start Network)</button>
    </div>

    <div id="result-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="modal-title" style="font-size: 2em; margin-bottom: 10px;"></h2>
            <div id="modal-icon" style="font-size: 4em; margin: 10px 0;"></div>
            <p id="modal-msg" style="margin: 20px 0; font-size: 1.1em; line-height: 1.6; color: #555;"></p>
            <button class="btn-action" id="modal-btn" onclick="nextLevel()">ä¸‹ä¸€é—œ (Next Level)</button>
        </div>
    </div>

    <script>
        // === 1. åœ–æ¨™èˆ‡æ¨™ç±¤åº« (Bilingual) ===
        const icons = {
            'pc': 'ğŸ’»', 'switch': 'ğŸ”Œ', 'router': 'ğŸ“¡', 'cloud': 'â˜ï¸',
            'hub': 'ğŸ•¸ï¸', 'ap': 'ğŸ“¶', 'phone': 'ğŸ“±', 'server': 'ğŸ–¥ï¸',
            'modem': 'ğŸ“Ÿ', 'printer': 'ğŸ–¨ï¸', 'laptop': 'ğŸ’»',
            'sat_dish': 'ğŸ“¡', 'headset': 'ğŸ§', 'bank': 'ğŸ¦',
            'nic_wired': 'ğŸ’³', 'nic_wireless': 'ğŸ“¶', 'display_card': 'ğŸï¸',
            'scanner': 'ğŸ“ ', 'bt_dongle': 'ğŸ¦·', 
            'utp': 'ğŸŸ ', 'stp': 'ğŸŸ£', 'fiber': 'ğŸ”µ', 'leased_line': 'ğŸ”’'
        };

        const labels = {
            'pc': 'å€‹äººé›»è…¦<br>PC', 
            'switch': 'äº¤æ›å™¨<br>Switch', 
            'router': 'è·¯ç”±å™¨<br>Router', 
            'cloud': 'äº’è¯ç¶²<br>Internet',
            'hub': 'é›†ç·šå™¨<br>Hub', 
            'ap': 'ç„¡ç·šæ¥é”é»<br>AP', 
            'phone': 'æ™ºèƒ½æ‰‹æ©Ÿ<br>Smartphone', 
            'server': 'ä¼ºæœå™¨<br>Server',
            'modem': 'æ•¸æ“šæ©Ÿ<br>Modem', 
            'printer': 'ç¶²çµ¡æ‰“å°æ©Ÿ<br>Printer', 
            'laptop': 'æ‰‹æé›»è…¦<br>Laptop',
            'sat_dish': 'è¡›æ˜Ÿå¤©ç·š<br>Satellite Dish', 
            'headset': 'è—ç‰™è€³æ©Ÿ<br>BT Headset', 
            'bank': 'éŠ€è¡Œç¸½éƒ¨<br>Bank HQ',
            'nic_wired': 'ç¶²çµ¡ä»‹é¢å¡<br>NIC', 
            'nic_wireless': 'ç„¡ç·šç¶²å¡<br>Wireless NIC', 
            'display_card': 'é¡¯ç¤ºå¡<br>Display Card',
            'scanner': 'æƒæå™¨<br>Scanner', 
            'bt_dongle': 'è—ç‰™é©é…å™¨<br>BT Dongle',
            'utp': 'ç„¡å±è”½é›™çµç·š<br>UTP', 
            'stp': 'å±è”½é›™çµç·š<br>STP', 
            'fiber': 'å…‰çº–<br>Optical Fiber', 
            'leased_line': 'å°ˆç·š<br>Leased Line'
        };

        // === 2. é—œå¡è¨­è¨ˆ (Corrected Paths & Bilingual) ===
        const levels = [
            {
                id: 1, title: "ç¬¬ 1 é—œ", concept: "Peer-to-Peer",
                desc: "å…©éƒ¨é›»è…¦éœ€è¦ç›´æ¥äº¤æ›æª”æ¡ˆï¼Œç„¡éœ€ä¸­å¤®ä¼ºæœå™¨ã€‚è«‹é¸æ“‡æœ€å¸¸ç”¨çš„**é›™çµç·š (UTP)** å°‡å®ƒå€‘é€£æ¥èµ·ä¾†ã€‚<br>(Connect two PCs directly using UTP cable.)",
                devices: [{t:'pc',x:150,y:200,l:'å·¥ä½œç«™ A<br>Workstation A'}, {t:'pc',x:750,y:200,l:'å·¥ä½œç«™ B<br>Workstation B'}],
                slots: [{x:450,y:200,req:'utp',type:'cable'}],
                lines: [{f:{x:195,y:200},t:{x:705,y:200},type:'slot'}],
                inv: ['utp', 'switch', 'fiber'],
                targetIdx: 1, // Green dot goes to device at index 1
                successMsg: "æ­£ç¢ºï¼<br>åœ¨ P2P ç¶²çµ¡ä¸­ï¼Œæ‰€æœ‰ç¯€é»åœ°ä½å¹³ç­‰ã€‚ç„¡å±è”½é›™çµç·š (UTP) æ˜¯æœ€å¸¸è¦‹çš„é€£æ¥ç·šæã€‚<br>(Correct! UTP is standard for LANs.)"
            },
            {
                id: 2, title: "ç¬¬ 2 é—œ", concept: "Wireless Access",
                desc: "å­¸æ ¡çš„**æ™ºèƒ½æ‰‹æ©Ÿ**éœ€è¦å­˜å–ä¼ºæœå™¨è³‡æ–™ã€‚æ‰‹æ©Ÿæ²’æœ‰ç¶²çµ¡ç·šæ’å­”ï¼Œæ‡‰å¦‚ä½•é€£æ¥è‡³æœ‰ç·šç¶²çµ¡ï¼Ÿ<br>(How to connect a Smartphone to the wired network?)",
                // FIX: Green dot path: Server(0) -> Switch(1) -> Slot(AP) -> Phone(2)
                devices: [{t:'server',x:100,y:250,l:'æª”æ¡ˆä¼ºæœå™¨<br>File Server'}, {t:'switch',x:350,y:250,l:'äº¤æ›å™¨<br>Switch'}, {t:'phone',x:800,y:350,l:'æ™ºèƒ½æ‰‹æ©Ÿ<br>Smartphone'}],
                slots: [{x:600,y:250,req:'ap'}], 
                lines: [
                    {f:{x:145,y:250},t:{x:305,y:250},type:'cable-copper'}, // Server->Switch
                    {f:{x:395,y:250},t:{x:550,y:250},type:'cable-copper'}, // Switch->Slot
                    {f:{x:650,y:260},t:{x:755,y:330},type:'cable-wireless'} // Slot->Phone
                ],
                inv: ['router', 'ap', 'pc'],
                targetIdx: 2, // IMPORTANT: Green dot goes to Phone (Index 2)
                successMsg: "æˆåŠŸï¼<br>ç„¡ç·šæ¥é”é» (AP) å……ç•¶æœ‰ç·šç¶²çµ¡èˆ‡ç„¡ç·šè£ç½®ä¹‹é–“çš„æ©‹æ¨‘ã€‚<br>(Success! AP bridges wired and wireless networks.)"
            },
            {
                id: 3, title: "ç¬¬ 3 é—œï¼š", concept: "Hub vs Switch",
                desc: "User A ç™¼é€è³‡æ–™çµ¦ User Bã€‚<br>âš ï¸ **è­¦å‘Š**ï¼šè«‹é¸æ“‡æ­£ç¢ºè¨­å‚™ï¼Œé¿å…è³‡æ–™è¢«é»‘å®¢ (Hacker) æˆªå–ã€‚<br>(Select the device that prevents data interception by Hacker.)",
                devices: [{t:'pc',x:100,y:150,l:'User A'}, {t:'pc',x:800,y:150,l:'User B'}, {t:'pc',x:450,y:350,l:'é»‘å®¢ (Hacker)'}],
                slots: [{x:450,y:150,req:'switch'}],
                lines: [
                    {f:{x:145,y:150},t:{x:400,y:150},type:'cable-copper'}, 
                    {f:{x:500,y:150},t:{x:755,y:150},type:'cable-copper'}, 
                    {f:{x:450,y:200},t:{x:450,y:305},type:'cable-copper'}
                ],
                inv: ['hub', 'switch'],
                targetIdx: 1, // Green dot goes to User B
                hackerIdx: 2, // Red dot goes to Hacker
                successMsg: "åšå¾—å¥½ï¼<br>äº¤æ›å™¨ (Switch) èƒ½è¾¨è­˜ç›®æ¨™åœ°å€ï¼Œåƒ…å°‡è³‡æ–™è½‰ç™¼è‡³ç›®æ¨™ã€‚<br>(Great! Switch only forwards data to the target.)",
                failMsg: "âŒ è³‡æ–™å¤–æ´©ï¼<br>é›†ç·šå™¨ (Hub) æœƒå°‡è¨Šè™Ÿã€Œå»£æ’­ã€è‡³æ‰€æœ‰é€£æ¥åŸ ï¼Œå°è‡´é»‘å®¢æ”¶åˆ°è³‡æ–™ã€‚<br>(Data Leak! Hub broadcasts data to everyone.)",
                isHackerLevel: true
            },
            {
                id: 4, title: "ç¬¬ 4 é—œï¼š", concept: "Hardware",
                desc: "é€™éƒ¨**èˆŠå¼é›»è…¦**çš„ä¸»æ©Ÿæ¿æ²’æœ‰å…§å»ºç¶²çµ¡æ¥å£ï¼Œéœ€è¦å®‰è£ä»€éº¼æ“´å……å¡æ‰èƒ½é€£æ¥åˆ°äº¤æ›å™¨ï¼Ÿ<br>(What card connects a PC to the network?)",
                devices: [{t:'pc',x:100,y:200,l:'èˆŠå¼é›»è…¦<br>Old PC'}, {t:'switch',x:700,y:200,l:'äº¤æ›å™¨<br>Switch'}],
                slots: [{x:400,y:200,req:'nic_wired'}],
                lines: [
                    {f:{x:145,y:200},t:{x:350,y:200},type:'cable-copper'}, 
                    {f:{x:450,y:200},t:{x:655,y:200},type:'cable-copper'}
                ],
                inv: ['nic_wired', 'nic_wireless', 'display_card'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>ç¶²çµ¡ä»‹é¢å¡ (NIC) æä¾› RJ-45 æ¥å£ï¼Œè² è²¬è™•ç†æ•¸æ“šå‚³é€ã€‚<br>(Correct. NIC provides RJ-45 interface.)"
            },
            {
                id: 5, title: "ç¬¬ 5 é—œï¼š", concept: "Wireless Hardware",
                desc: "é€™éƒ¨**æ‰‹æé›»è…¦**å¸Œæœ›é€£æ¥ Wi-Fiï¼Œå®ƒéœ€è¦å…·å‚™ä»€éº¼ç¡¬ä»¶ï¼Ÿ<br>(What hardware connects a laptop to Wi-Fi?)",
                devices: [{t:'laptop',x:100,y:200,l:'æ‰‹æé›»è…¦<br>Laptop'}, {t:'ap',x:700,y:200,l:'ç„¡ç·šæ¥é”é»<br>AP'}],
                slots: [{x:400,y:200,req:'nic_wireless'}],
                lines: [
                    {f:{x:145,y:200},t:{x:350,y:200},type:'cable-copper'}, // Bus
                    {f:{x:450,y:200},t:{x:655,y:200},type:'cable-wireless'}
                ],
                inv: ['nic_wired', 'nic_wireless'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>ç„¡ç·šç¶²çµ¡ä»‹é¢å¡ (Wireless NIC) è² è²¬å°‡æ•¸ä½è¨Šè™Ÿè½‰æ›ç‚ºç„¡ç·šé›»æ³¢ã€‚<br>(Correct. W-NIC handles radio signals.)"
            },
            {
                id: 6, title: "ç¬¬ 6 é—œï¼š", concept: "Resource Sharing",
                desc: "è¾¦å…¬å®¤å¸Œæœ›æ‰€æœ‰å“¡å·¥å…±ç”¨ä¸€éƒ¨æ‰“å°æ©Ÿã€‚è«‹å°‡**æ‰“å°æ©Ÿ**é€£æ¥è‡³ç¶²çµ¡äº¤æ›å™¨ã€‚<br>(Connect the printer to the switch for sharing.)",
                devices: [{t:'switch',x:200,y:200,l:'äº¤æ›å™¨<br>Switch'}], 
                slots: [{x:600,y:200,req:'printer'}],
                lines: [{f:{x:245,y:200},t:{x:550,y:200},type:'cable-copper'}],
                inv: ['printer', 'scanner'],
                targetIsSlot: true, // Target is the slot itself
                successMsg: "æ­£ç¢ºï¼<br>é€£æ¥è‡³äº¤æ›å™¨çš„ç¶²çµ¡æ‰“å°æ©Ÿå¯ä¾›å€åŸŸç¶²çµ¡å…§æ‰€æœ‰ä½¿ç”¨è€…å…±äº«ã€‚<br>(Correct! Network Printer is shared.)"
            },
            {
                id: 7, title: "ç¬¬ 7 é—œï¼š", concept: "Transmission Media",
                desc: "è¾¦å…¬å®¤å…§çŸ­è·é›¢å‚³è¼¸ (ä¾‹å¦‚ 100ç±³å…§)ï¼Œæœ€ç¶“æ¿Ÿä¸”å¸¸ç”¨çš„ç·šææ˜¯ä»€éº¼ï¼Ÿ<br>(Most common cable for short distances?)",
                devices: [{t:'pc',x:200,y:200,l:'é›»è…¦<br>PC'}, {t:'switch',x:750,y:200,l:'äº¤æ›å™¨<br>Switch'}],
                slots: [{x:450,y:200,req:'utp',type:'cable'}],
                lines: [{f:{x:245,y:200},t:{x:705,y:200},type:'slot'}],
                inv: ['utp', 'fiber', 'stp'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>ç„¡å±è”½é›™çµç·š (UTP) æˆæœ¬ä½å»‰ï¼Œæ˜“æ–¼å®‰è£ã€‚<br>(Correct. UTP is standard for Ethernet.)"
            },
            {
                id: 8, title: "ç¬¬ 8 é—œï¼š", concept: "Shielding",
                desc: "å·¥å» ç’°å¢ƒå……æ»¿å¤§å‹é¦¬é”ï¼Œç”¢ç”Ÿé«˜é›»ç£å¹²æ“¾ (EMI)ã€‚æ™®é€š UTP è¨Šè™Ÿå—æï¼Œæ‡‰æ”¹ç”¨ä»€éº¼ï¼Ÿ<br>(High EMI environment. Which cable to use?)",
                devices: [{t:'pc',x:150,y:200,l:'å·¥æ¥­é›»è…¦<br>Industrial PC'}, {t:'switch',x:750,y:200,l:'äº¤æ›å™¨<br>Switch'}],
                slots: [{x:450,y:200,req:'stp',type:'cable'}],
                lines: [{f:{x:195,y:200},t:{x:705,y:200},type:'slot'}],
                env: {type: 'noise', rect: [300, 100, 300, 200]}, 
                inv: ['utp', 'stp', 'fiber'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºï¼<br>å±è”½é›™çµç·š (STP) å…·æœ‰é‡‘å±¬ç¶²å±¤ï¼Œèƒ½æœ‰æ•ˆæŠµç¦¦é›»ç£å¹²æ“¾ã€‚<br>(Correct! STP blocks EMI.)",
                failMsg: "âŒ å‚³è¼¸å¤±æ•—ï¼<br>ç„¡å±è”½é›™çµç·š (UTP) å—åˆ°é›»ç£å¹²æ“¾ï¼Œå°è‡´æ•¸æ“šææ¯€ã€‚<br>(Fail! UTP is affected by EMI.)"
            },
            {
                id: 9, title: "ç¬¬ 9 é—œï¼š", concept: "Fiber Optics",
                desc: "é€£æ¥å…©æ£Ÿç›¸è· 3å…¬é‡Œçš„æ ¡åœ’å¤§æ¨“ã€‚éŠ…ç·šè¨Šè™Ÿè¡°æ¸›éå¤§ï¼Œæ‡‰ä½¿ç”¨ä»€éº¼åª’ä»‹ï¼Ÿ<br>(Connect buildings 3km apart. Copper is too short.)",
                devices: [{t:'switch',x:100,y:200,l:'A åº§<br>Block A'}, {t:'switch',x:700,y:200,l:'B åº§<br>Block B'}],
                slots: [{x:400,y:200,req:'fiber',type:'cable'}],
                lines: [{f:{x:145,y:200},t:{x:655,y:200},type:'slot'}],
                inv: ['utp', 'fiber'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºï¼<br>å…‰çº– (Optical Fiber) åˆ©ç”¨å…¨å…§åå°„åŸç†å‚³è¼¸ï¼Œé©åˆé•·è·é›¢éª¨å¹¹ç¶²çµ¡ã€‚<br>(Correct! Fiber uses light for long distances.)"
            },
            {
                id: 10, title: "ç¬¬ 10 é—œï¼š", concept: "Bluetooth",
                desc: "ä½¿ç”¨ç„¡ç·šè€³æ©Ÿé€£æ¥æ‰‹æ©Ÿï¼Œå±¬æ–¼å€‹äººå€åŸŸç¶²çµ¡ (PAN)ã€‚è«‹é¸æ“‡é©ç•¶çš„ç„¡ç·šæŠ€è¡“ã€‚<br>(Connect wireless headset to phone.)",
                devices: [{t:'phone',x:200,y:200,l:'æ‰‹æ©Ÿ<br>Phone'}],
                slots: [{x:600,y:200,req:'headset'}],
                lines: [{f:{x:245,y:200},t:{x:555,y:200},type:'cable-bluetooth'}],
                inv: ['headset', 'ap'],
                targetIsSlot: true,
                successMsg: "æ­£ç¢ºã€‚<br>è—ç‰™ (Bluetooth) æ˜¯çŸ­è·é›¢ç„¡ç·šé€šè¨Šæ¨™æº–ï¼Œå°ˆç‚ºä½åŠŸè€—è¨­å‚™è¨­è¨ˆã€‚<br>(Correct. Bluetooth is for PAN.)"
            },
            {
                id: 11, title: "ç¬¬ 11 é—œï¼š", concept: "WLAN Mode",
                desc: "åœ–æ›¸é¤¨å¸Œæœ›å»ºç«‹ç„¡ç·šå€åŸŸç¶²çµ¡ (WLAN) ä¾›è®€è€…ä¸Šç¶²ã€‚æ ¸å¿ƒè¨­å‚™æ˜¯ä»€éº¼ï¼Ÿ<br>(Core device for WLAN in library?)",
                devices: [{t:'switch',x:200,y:300,l:'äº¤æ›å™¨<br>Switch'}, {t:'phone',x:600,y:100,l:'è®€è€…<br>Reader'}],
                slots: [{x:400,y:200,req:'ap'}],
                lines: [{f:{x:245,y:280},t:{x:355,y:220},type:'cable-copper'}, {f:{x:445,y:190},t:{x:555,y:120},type:'cable-wireless'}],
                inv: ['ap', 'router'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>åœ¨åŸºç¤æ¶æ§‹æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰ç„¡ç·šè£ç½®å‡é€šéç„¡ç·šæ¥é”é» (AP) é€²è¡Œé€šè¨Šã€‚<br>(Correct. Infrastructure mode uses AP.)"
            },
            {
                id: 12, title: "ç¬¬ 12 é—œï¼š", concept: "SSID",
                desc: "æ ¡åœ’ç¯„åœå»£å¤§ï¼Œéœ€è¦å¢åŠ ç¬¬äºŒå€‹ APã€‚ç‚ºç¢ºä¿è£ç½®è‡ªå‹•åˆ‡æ›ï¼Œè«‹é¸æ“‡æ­£ç¢ºè¨­å‚™ã€‚<br>(Add 2nd AP for seamless roaming.)",
                devices: [{t:'switch',x:400,y:350,l:'äº¤æ›å™¨<br>Switch'}, {t:'ap',x:200,y:200,l:'AP (Aå€)'}, {t:'phone',x:400,y:100,l:'ç”¨æˆ¶<br>User'}],
                slots: [{x:600,y:200,req:'ap'}],
                lines: [{f:{x:355,y:330},t:{x:245,y:245},type:'cable-copper'}, {f:{x:445,y:330},t:{x:555,y:245},type:'cable-copper'}],
                inv: ['ap', 'router'],
                targetIsSlot: true,
                successMsg: "æ­£ç¢ºã€‚<br>å¤šå€‹ AP è¨­å®šç›¸åŒçš„æœå‹™é›†è­˜åˆ¥ç¢¼ (SSID)ï¼Œå¯å¯¦ç¾ç„¡ç·šæ¼«éŠã€‚<br>(Correct. Same SSID allows roaming.)"
            },
            {
                id: 13, title: "ç¬¬ 13 é—œï¼š", concept: "Satellite",
                desc: "ç§‘å­¸è€ƒå¯ŸéšŠä½æ–¼åé å±±å€ï¼Œç„¡æ³•é€£æ¥å…‰çº–æˆ–åŸºåœ°å°ã€‚ä»–å€‘å¦‚ä½•é€£æ¥äº’è¯ç¶²ï¼Ÿ<br>(Internet for remote areas?)",
                devices: [{t:'pc',x:200,y:300,l:'é›»è…¦<br>PC'}],
                slots: [{x:500,y:100,req:'sat_dish'}],
                lines: [{f:{x:245,y:290},t:{x:455,y:130},type:'cable-satellite'}],
                inv: ['sat_dish', 'ap', 'fiber'],
                targetIsSlot: true,
                successMsg: "æ­£ç¢ºã€‚<br>è¡›æ˜Ÿé€šè¨Šè¦†è“‹ç¯„åœæ¥µå»£ï¼Œä¸å—åœ°å½¢é™åˆ¶ã€‚<br>(Correct. Satellite covers remote areas.)"
            },
            {
                id: 14, title: "ç¬¬ 14 é—œï¼š", concept: "Routing",
                desc: "å€åŸŸç¶²çµ¡ (LAN) éœ€è¦é€£æ¥è‡³äº’è¯ç¶² (WAN)ã€‚å“ªç¨®è¨­å‚™è² è²¬å°‹æ‰¾è·¯å¾‘ä¸¦è½‰ç™¼å°åŒ…ï¼Ÿ<br>(Device connecting LAN to WAN?)",
                devices: [{t:'switch',x:200,y:200,l:'LAN'}, {t:'cloud',x:750,y:200,l:'äº’è¯ç¶²<br>Internet'}],
                slots: [{x:475,y:200,req:'router'}],
                lines: [{f:{x:245,y:200},t:{x:430,y:200},type:'cable-copper'}, {f:{x:520,y:200},t:{x:705,y:200},type:'cable-copper'}],
                inv: ['router', 'switch'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>è·¯ç”±å™¨ (Router) æ ¹æ“š IP åœ°å€æ±ºå®šæ•¸æ“šå°åŒ…çš„æœ€ä½³å‚³è¼¸è·¯å¾‘ã€‚<br>(Correct. Router determines best path.)"
            },
            {
                id: 15, title: "ç¬¬ 15 é—œï¼š", concept: "Modulation",
                desc: "ä½¿ç”¨å‚³çµ±é›»è©±ç·šè·¯ (æ¨¡æ“¬è¨Šè™Ÿ) ä¸Šç¶²ã€‚éœ€è¦ä»€éº¼è¨­å‚™å°‡é›»è…¦çš„æ•¸ç¢¼è¨Šè™Ÿé€²è¡Œè½‰æ›ï¼Ÿ<br>(Convert Digital to Analog?)",
                devices: [{t:'router',x:200,y:200,l:'è·¯ç”±å™¨<br>Router'}, {t:'cloud',x:700,y:200,l:'ISP'}],
                slots: [{x:450,y:200,req:'modem'}],
                lines: [{f:{x:245,y:200},t:{x:405,y:200},type:'cable-copper'}, {f:{x:495,y:200},t:{x:655,y:200},type:'cable-copper'}],
                inv: ['modem', 'switch'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>æ•¸æ“šæ©Ÿ (Modem) è² è²¬èª¿è®Š (Digital to Analog) èˆ‡è§£èª¿ã€‚<br>(Correct. Modem handles Modulation/Demodulation.)"
            },
            {
                id: 16, title: "ç¬¬ 16 é—œï¼š", concept: "Security",
                desc: "éŠ€è¡Œç¸½éƒ¨èˆ‡åˆ†è¡Œä¹‹é–“éœ€è¦**é«˜åº¦å®‰å…¨**ä¸”**é »å¯¬ä¿è­‰**çš„é€£æ¥ã€‚<br>(Secure and guaranteed connection for Bank.)",
                devices: [{t:'bank',x:150,y:200,l:'ç¸½è¡Œ<br>HQ'}, {t:'bank',x:750,y:200,l:'åˆ†è¡Œ<br>Branch'}],
                slots: [{x:450,y:200,req:'leased_line',type:'cable'}],
                lines: [{f:{x:195,y:200},t:{x:705,y:200},type:'slot'}],
                inv: ['leased_line', 'cloud'],
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>å°ˆç·š (Leased Line) æä¾›é»å°é»çš„å°ˆç”¨é€£æ¥ï¼Œå®‰å…¨æ€§æ¥µé«˜ã€‚<br>(Correct. Leased Line is secure and dedicated.)"
            },
            {
                id: 17, title: "ç¬¬ 17 é—œ: ", concept: "High Speed",
                desc: "å…¬å¸é€²è¡Œ 4K è¦–åƒæœƒè­°æ™‚å‡ºç¾åš´é‡å»¶é²ã€‚ç¾æœ‰éŠ…ç·šé »å¯¬ä¸è¶³ï¼Œæ‡‰å‡ç´šç‚ºï¼Ÿ<br>(Upgrade for 4K video conferencing?)",
                devices: [{t:'pc',x:150,y:200,l:'æœƒè­°å®¤<br>Conf Room'}, {t:'cloud',x:750,y:200,l:'äº’è¯ç¶²<br>Internet'}],
                slots: [{x:450,y:200,req:'fiber',type:'cable'}], 
                lines: [{f:{x:195,y:200},t:{x:705,y:200},type:'slot'}],
                inv: ['fiber', 'utp'], 
                targetIdx: 1,
                successMsg: "æ­£ç¢ºã€‚<br>å…‰çº–æä¾›æ¥µé«˜çš„é »å¯¬ (Bandwidth)ï¼Œé©åˆå‚³è¼¸å¤§é‡å¤šåª’é«”æ•¸æ“šã€‚<br>(Correct. Fiber offers high bandwidth.)"
            },
            {
                id: 18, title: "ç¬¬ 18 é—œï¼š", concept: "SOHO Router",
                desc: "ç¾ä»£å®¶åº­é€šå¸¸ä½¿ç”¨ã€Œå¤šåˆä¸€ã€è¨­å‚™ä¾†é€£æ¥ ISPã€‚è«‹é¸æ“‡è©²è¨­å‚™ã€‚<br>(All-in-one device for home?)",
                devices: [{t:'pc',x:150,y:100,l:'é›»è…¦<br>PC'}, {t:'phone',x:150,y:300,l:'æ‰‹æ©Ÿ<br>Phone'}, {t:'modem',x:650,y:200,l:'æ•¸æ“šæ©Ÿ<br>Modem'}],
                slots: [{x:400,y:200,req:'router'}],
                lines: [{f:{x:195,y:120},t:{x:355,y:180},type:'cable-copper'}, {f:{x:195,y:280},t:{x:355,y:220},type:'cable-wireless'}, {f:{x:445,y:200},t:{x:605,y:200},type:'cable-copper'}],
                inv: ['router', 'switch', 'ap'],
                targetIdx: 2,
                successMsg: "æ­£ç¢ºã€‚<br>å®¶ç”¨ç„¡ç·šè·¯ç”±å™¨å¯¦éš›ä¸Šæ•´åˆäº† Switch, AP åŠ Router åŠŸèƒ½ã€‚<br>(Correct. Home Router is all-in-one.)"
            },
            {
                id: 19, title: "ç¬¬ 19 é—œï¼š", concept: "Low Power",
                desc: "æ™ºèƒ½ç‡ˆæ³¡éœ€è¦èˆ‡æ‰‹æ©Ÿé€£æ¥ï¼Œè¦æ±‚ä½åŠŸè€—ä¸”é…å°ç°¡å–®ã€‚<br>(Low power connection for IoT bulb?)",
                devices: [{t:'phone',x:200,y:200,l:'æ‰‹æ©Ÿ<br>Phone'}],
                slots: [{x:600,y:200,req:'bt_dongle'}], 
                lines: [{f:{x:245,y:200},t:{x:555,y:200},type:'cable-bluetooth'}],
                inv: ['bt_dongle', 'fiber'],
                targetIsSlot: true,
                successMsg: "æ­£ç¢ºã€‚<br>IoT è£ç½®å¸¸åˆ©ç”¨è—ç‰™ (Bluetooth) æˆ– Zigbee ç­‰ä½åŠŸè€—æŠ€è¡“ã€‚<br>(Correct. Bluetooth/Zigbee for IoT.)"
            },
            {
                id: 20, title: "ç¬¬ 20 é—œï¼šçµ‚æ¥µæ¸¬è©¦ ", concept: "Topology",
                desc: "è«‹çµ„å»ºå®Œæ•´çš„å­¸æ ¡ç¶²çµ¡ï¼š<br>1. æ‰‹æ©Ÿé€£ç„¡ç·š<br>2. ä¼ºæœå™¨é€£äº¤æ›å™¨<br>3. äº¤æ›å™¨é€£è·¯ç”±å™¨<br>4. è·¯ç”±å™¨é€£æ•¸æ“šæ©Ÿ<br>(Build a complete school network.)",
                devices: [
                    {t:'phone',x:50,y:100,l:'ç”¨æˆ¶<br>User'}, {t:'server',x:50,y:300,l:'ä¼ºæœå™¨<br>Server'},
                    {t:'cloud',x:850,y:200,l:'äº’è¯ç¶²<br>Internet'}
                ],
                slots: [
                    {x:200,y:150,req:'ap'}, {x:200,y:300,req:'switch'},
                    {x:450,y:200,req:'router'}, {x:650,y:200,req:'modem'}
                ],
                lines: [
                    {f:{x:95,y:120},t:{x:155,y:140},type:'cable-wireless'}, // Phone->AP
                    {f:{x:95,y:300},t:{x:155,y:300},type:'cable-copper'}, // Server->Switch
                    {f:{x:200,y:195},t:{x:200,y:255},type:'cable-copper'}, // AP->Switch
                    {f:{x:245,y:300},t:{x:405,y:220},type:'cable-copper'}, // Switch->Router
                    {f:{x:495,y:200},t:{x:605,y:200},type:'cable-copper'}, // Router->Modem
                    {f:{x:695,y:200},t:{x:805,y:200},type:'cable-copper'}  // Modem->Cloud
                ],
                inv: ['ap', 'switch', 'router', 'modem', 'hub'],
                targetIdx: 2, // Internet
                successMsg: "æ­å–œï¼<br>ä½ å·²ç¶“æŒæ¡äº†ç¶²çµ¡æ¶æ§‹çš„æ ¸å¿ƒæ¦‚å¿µï¼Œé€šéäº†çµ‚æ¥µæ¸¬è©¦ï¼<br>(Congratulations! You mastered it!)"
            }
        ];

        // === 3. éŠæˆ²å¼•æ“ ===
        let currentLevelIdx = 0;
        let selectedItem = null;
        let placedItems = {}; 

        function initLevel() {
            const level = levels[currentLevelIdx];
            document.getElementById('lvl-title').innerText = level.title;
            document.getElementById('lvl-concept').innerText = level.concept;
            document.getElementById('lvl-desc').innerHTML = level.desc;
            document.getElementById('result-modal').classList.add('hidden');
            
            const btn = document.getElementById('btn-test');
            btn.disabled = false;
            
            selectedItem = null;
            placedItems = {};
            
            const board = document.getElementById('device-layer');
            const envLayer = document.getElementById('env-layer');
            const svg = document.getElementById('svg-lines');
            const inv = document.getElementById('inventory');
            const pktContainer = document.getElementById('packet-container');
            
            board.innerHTML = '';
            envLayer.innerHTML = '';
            svg.innerHTML = '';
            inv.innerHTML = '';
            pktContainer.innerHTML = '';

            if (level.env) {
                const z = document.createElement('div');
                z.className = 'noise-zone';
                const [x, y, w, h] = level.env.rect;
                z.style.left = x+'px'; z.style.top = y+'px';
                z.style.width = w+'px'; z.style.height = h+'px';
                z.innerText = "âš¡ é«˜å¹²æ“¾å€åŸŸ (High EMI) âš¡";
                envLayer.appendChild(z);
            }

            level.lines.forEach((line, idx) => {
                const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                l.setAttribute('x1', line.f.x); l.setAttribute('y1', line.f.y);
                l.setAttribute('x2', line.t.x); l.setAttribute('y2', line.t.y);
                
                if (line.type === 'slot') {
                    l.setAttribute('class', 'cable-slot'); 
                    l.id = `line-slot-${idx}`; 
                } else {
                    l.setAttribute('class', `cable-${line.type.split('-')[1] || 'copper'}`);
                }
                svg.appendChild(l);
            });

            level.devices.forEach(dev => {
                const div = document.createElement('div');
                div.className = 'device';
                div.style.left = (dev.x - 50) + 'px';
                div.style.top = (dev.y - 45) + 'px';
                div.innerHTML = `
                    <span class="device-icon">${icons[dev.t]}</span>
                    <span class="device-label">${dev.l}</span>
                `;
                board.appendChild(div);
            });

            level.slots.forEach((slot, index) => {
                const div = document.createElement('div');
                div.className = slot.type === 'cable' ? 'slot slot-cable' : 'slot';
                div.style.left = slot.x + 'px';
                div.style.top = slot.y + 'px';
                div.dataset.index = index;
                div.innerHTML = slot.type === 'cable' ? 'é¸æ“‡ç·šæ<br>(Select Cable)' : 'æ”¾ç½®è¨­å‚™<br>(Place Device)';
                div.onclick = () => placeItem(index, slot.type === 'cable');
                board.appendChild(div);
            });

            level.inv.forEach(key => {
                const div = document.createElement('div');
                div.className = 'inv-item';
                // ç§»é™¤ splitï¼Œä¿ç•™å®Œæ•´é›™èªæ¨™ç±¤
                div.innerHTML = `<div style="font-size:1.8em">${icons[key]}</div><div>${labels[key]}</div>`;
                div.onclick = (e) => selectInventory(key, div);
                inv.appendChild(div);
            });
        }

        function selectInventory(key, el) {
            document.querySelectorAll('.inv-item').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            selectedItem = key;
        }

        function placeItem(slotIdx, isCable) {
            if (!selectedItem) {
                alert("è«‹å…ˆåœ¨ä¸‹æ–¹ç‰©å“æ¬„é¸æ“‡ä¸€å€‹é …ç›®ï¼\n(Please select an item first!)");
                return;
            }
            placedItems[slotIdx] = selectedItem;
            
            const slotDiv = document.querySelectorAll('.slot')[slotIdx];
            slotDiv.classList.add('filled');
            
            if (isCable) {
                // æ”¾ç½®æ™‚å¯ä»¥åªé¡¯ç¤ºä¸­æ–‡æˆ–ç°¡çŸ­åç¨±ï¼Œä»¥å…æ ¼å­å¤ªæ“ 
                let shortLabel = labels[selectedItem].split('<br>')[0]; 
                slotDiv.innerHTML = `${icons[selectedItem]} ${shortLabel}`;
                const lines = document.querySelectorAll('.cable-slot');
                lines.forEach(l => {
                    l.setAttribute('class', `cable-${selectedItem}`);
                });
            } else {
                let shortLabel = labels[selectedItem].split('<br>')[0];
                slotDiv.innerHTML = `
                    <div class="device-icon">${icons[selectedItem]}</div>
                    <div style="font-size:0.8em; color:#333;">${shortLabel}</div>
                `;
            }
        }

        function testNetwork() {
            const level = levels[currentLevelIdx];
            const btn = document.getElementById('btn-test');
            
            if (Object.keys(placedItems).length < level.slots.length) {
                alert("è«‹å¡«æ»¿æ‰€æœ‰è™›ç·šæ¡†æ ¼ï¼\n(Please fill all slots!)");
                return;
            }

            let isCorrect = true;
            let isHubFail = false; 

            level.slots.forEach((slot, idx) => {
                if (placedItems[idx] !== slot.req) {
                    isCorrect = false;
                    if (placedItems[idx] === 'hub' && level.isHackerLevel) isHubFail = true;
                }
            });

            if (level.id === 8 && placedItems[0] === 'utp') {
                isCorrect = false; 
            }

            btn.disabled = true;
            
            if (isCorrect) {
                runPacketAnimation('correct', () => showResult(true, level.successMsg));
            } else {
                if (isHubFail) {
                    runPacketAnimation('hub_fail', () => showResult(false, level.failMsg));
                } else {
                    runPacketAnimation('fail', () => showResult(false, level.failMsg || "é…ç½®éŒ¯èª¤ã€‚è¨Šè™Ÿç„¡æ³•é€é”ã€‚<br>(Config Error. Signal lost.)"));
                }
            }
        }

        function runPacketAnimation(type, callback) {
            const level = levels[currentLevelIdx];
            const container = document.getElementById('packet-container');
            container.innerHTML = '';
            
            // --- è·¯å¾‘è¨ˆç®—é‚è¼¯ä¿®æ­£ ---
            const startDev = level.devices[0]; 
            let destDev;

            // 1. å¦‚æœæœ‰ targetIsSlotï¼Œç›®æ¨™æ˜¯ Slot æœ¬èº« (Level 6 Printer / Level 10 BT)
            if (level.targetIsSlot) {
                destDev = {x: level.slots[0].x, y: level.slots[0].y};
            } 
            // 2. å¦‚æœæŒ‡å®šäº† targetIdx (è§£æ±º Level 2/3 å•é¡Œ)
            else if (level.targetIdx !== undefined) {
                destDev = level.devices[level.targetIdx];
            } 
            // 3. é è¨­ï¼šåˆ—è¡¨ä¸­çš„æœ€å¾Œä¸€å€‹
            else {
                destDev = level.devices[level.devices.length - 1];
            }

            let pathSegments = [];
            pathSegments.push({x: startDev.x, y: startDev.y});
            
            // åŠ å…¥ä¸­é–“ Slot é» (æŒ‰é †åº)
            level.slots.forEach(s => pathSegments.push({x: s.x, y: s.y})); 
            
            // åŠ å…¥çµ‚é»
            if (!level.targetIsSlot) {
                pathSegments.push({x: destDev.x, y: destDev.y});
            }

            // å‰µå»ºä¸»å°åŒ…
            const pkt = document.createElement('div');
            pkt.className = 'packet';
            container.appendChild(pkt);

            if (type === 'hub_fail') {
                // Hub å»£æ’­: èµ°åˆ° Hub (Slot 0) å¾Œåˆ†è£‚
                // è·¯å¾‘: Start -> Slot -> (Split) -> Dest / Hacker
                let hubPos = {x: level.slots[0].x, y: level.slots[0].y};
                
                animateSingleMove(pkt, {x:startDev.x, y:startDev.y}, hubPos, 'var(--success)', () => {
                    // åˆ°é” Hubï¼Œç”¢ç”Ÿç´…è‰²å°åŒ…é£›å‘ Hacker
                    const hackerDev = level.devices[level.hackerIdx]; 
                    const pktHacker = document.createElement('div');
                    pktHacker.className = 'packet packet-hacker'; 
                    pktHacker.style.left = hubPos.x + 'px';
                    pktHacker.style.top = hubPos.y + 'px';
                    pktHacker.style.display = 'block';
                    container.appendChild(pktHacker);

                    // ç´… -> Hacker
                    animateSingleMove(pktHacker, hubPos, {x: hackerDev.x, y: hackerDev.y}, 'var(--danger)', () => {
                        callback(); 
                    });
                    
                    // ç¶  -> Dest (é›–ç„¶å¤±æ•—ï¼Œä½† Hub å…¶å¯¦ä¹Ÿæœƒå‚³çµ¦æ­£ç¢ºç›®æ¨™ï¼Œåªæ˜¯ä¸å®‰å…¨)
                    animateSingleMove(pkt, hubPos, {x: destDev.x, y: destDev.y}, 'var(--success)', () => {});
                });

            } else if (type === 'correct') {
                // ä¿®æ­£ï¼šä½¿ç”¨å¤šæ®µå‹•ç•«å‡½æ•¸ï¼Œç¢ºä¿ä¸æœƒè·³éä¸­é–“é»
                animateSequence(pkt, pathSegments, 0, callback);
            } else {
                // å¤±æ•—ï¼šè®Šç´…ä¸¦åœæ­¢
                pkt.classList.add('packet-hacker');
                setTimeout(callback, 800);
            }
        }

        function animateSingleMove(el, from, to, color, onDone) {
            el.style.backgroundColor = color;
            el.style.display = 'block';
            el.animate([
                { left: from.x + 'px', top: from.y + 'px' },
                { left: to.x + 'px', top: to.y + 'px' }
            ], {
                duration: 800, fill: 'forwards', easing: 'linear'
            }).onfinish = () => {
                el.style.left = to.x + 'px';
                el.style.top = to.y + 'px';
                onDone();
            };
        }

        function animateSequence(el, points, idx, onDone) {
            if (idx >= points.length - 1) {
                onDone();
                return;
            }
            const p1 = points[idx];
            const p2 = points[idx+1];
            
            el.style.display = 'block';
            el.style.left = p1.x + 'px';
            el.style.top = p1.y + 'px';

            el.animate([
                { left: p1.x + 'px', top: p1.y + 'px' },
                { left: p2.x + 'px', top: p2.y + 'px' }
            ], {
                duration: 600, fill: 'forwards', easing: 'linear'
            }).onfinish = () => {
                animateSequence(el, points, idx + 1, onDone);
            };
        }

        function showResult(success, msg) {
            const modal = document.getElementById('result-modal');
            const title = document.getElementById('modal-title');
            const icon = document.getElementById('modal-icon');
            const mMsg = document.getElementById('modal-msg');
            const btn = document.getElementById('modal-btn');
            
            modal.classList.remove('hidden');
            mMsg.innerHTML = msg;
            
            if (success) {
                title.innerText = "ğŸ‰ ä»»å‹™å®Œæˆ (Completed!)";
                title.style.color = "var(--success)";
                icon.innerHTML = "âœ…";
                btn.innerText = "ä¸‹ä¸€é—œ (Next Level)";
                btn.onclick = nextLevel;
            } else {
                title.innerText = "âš ï¸ é€£ç·šå¤±æ•— (Failed)";
                title.style.color = "var(--danger)";
                icon.innerHTML = "âŒ";
                btn.innerText = "å†è©¦ä¸€æ¬¡ (Retry)";
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    document.getElementById('btn-test').disabled = false;
                    document.getElementById('packet-container').innerHTML = '';
                };
            }
        }

        function nextLevel() {
            currentLevelIdx++;
            if (currentLevelIdx >= levels.length) {
                currentLevelIdx = 0; 
                alert("æ­å–œé€šé—œæ‰€æœ‰ 20 é—œï¼\n(Congratulations! All levels completed!)");
            }
            initLevel();
        }

        // å•Ÿå‹•
        initLevel();

    </script>
</body>
</html>
